@using jinx_debt_tracker.Models
@using jinx_debt_tracker.Services
@inherits IgnisAsyncComponentBase
@inject PlayerService playerService
@inject GameService gameService

<div class="rounded-2xl bg-white dark:bg-black shadow-lg ring-1 ring-gray-900/5 dark:ring-gray-800">
    <TabGroup>
        <TabList class="flex space-x-1 rounded-t-2xl bg-gray-100 dark:bg-gray-800 p-1">
            @foreach (var category in _resourcesByCategory.Keys)
            {
                <Tab AsComponent="typeof(Fragment)" Context="tab">
                    <button @ref="tab.Element"
                            @attributes="tab.Attributes"
                            class="@Css.Class("w-full rounded-lg py-2.5 px-4 text-sm font-medium leading-5 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-black", tab.IsSelected ? "text-blue-600 dark:text-white bg-white dark:bg-black shadow-sm" : "text-gray-600 dark:text-gray-400 hover:bg-white/50 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-white")"
                            type="button">
                        @category
                    </button>
                </Tab>
            }
        </TabList>
        <TabPanels class="p-6">
            @foreach (var (category, resources) in _resourcesByCategory)
            {
                <TabPanel @key="category"
                          class="focus:outline-none"
                          Context="_">
                    <div class="space-y-6">
                        @foreach (var resource in resources)
                        {
                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                <!-- Score Card -->
                                <div class="rounded-lg bg-gray-50 dark:bg-gray-800 p-4">
                                    <div class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Score</div>
                                    <div class="text-2xl font-bold text-gray-900 dark:text-white">@resource.Score</div>
                                </div>
                                
                                <!-- Leader Card -->
                                <div class="rounded-lg bg-gray-50 dark:bg-gray-800 p-4">
                                    <div class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Leader</div>
                                    <div class="text-xl font-semibold text-gray-900 dark:text-white">@resource.Advantage</div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                                <button type="button"
                                        @onclick="() => AdvancePlayer1(resource.Game)"
                                        class="flex-1 rounded-lg bg-blue-600 dark:bg-white dark:text-black px-4 py-3 text-sm font-semibold text-white hover:bg-blue-700 dark:hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-black transition-colors">
                                    Point for @GetPlayer1Name(resource.Game)
                                </button>
                                <button type="button"
                                        @onclick="() => AdvancePlayer2(resource.Game)"
                                        class="flex-1 rounded-lg bg-blue-600 dark:bg-white dark:text-black px-4 py-3 text-sm font-semibold text-white hover:bg-blue-700 dark:hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-black transition-colors">
                                    Point for @GetPlayer2Name(resource.Game)
                                </button>
                            </div>
                        }
                    </div>
                </TabPanel>
            }
        </TabPanels>
    </TabGroup>
</div>

@code
{

    [Parameter] public List<Game> Games { get; set; } = new();
    [Parameter] public EventCallback<Game> OnGameUpdated { get; set; }

    protected override async Task OnInitializedAsync(CancellationToken token)
    {
        await playerService.GetAllPlayers();
        RefreshResources();
    }

    private void RefreshResources()
    {
        _resourcesByCategory.Clear();
        foreach (var game in Games)
        {
            _resourcesByCategory.Add(
                $"{(playerService.PlayerList[game.Player1_ID].Name)} VS {playerService.PlayerList[game.Player2_ID].Name}", new Resource[]
                {
                    new()
                    {
                        Score = GetPositiveScore(game),
                        Advantage = GetWinnerName(game),
                        Game = game
                    }
                }
            );
        }
    }

    private string GetWinnerName(Game game)
    {
        switch (game.Advantage)
        {
            case 1: return playerService.PlayerList[game.Player1_ID].Name;
            case 2: return playerService.PlayerList[game.Player2_ID].Name;
            default: return "Tie";
        }
    }
    
    private string GetPlayer1Name(Game game) => playerService.PlayerList[game.Player1_ID].Name;
    private string GetPlayer2Name(Game game) => playerService.PlayerList[game.Player2_ID].Name;

    private int GetPositiveScore(Game game)
    {
        switch (game.Advantage)
        {
            case 1: return game.Player1_Score;
            case 2: return game.Player2_Score;
            default: return 0;
        }
    }

    private async Task AdvancePlayer1(Game game)
    {
        game.Player1_Score += 1;
        game.Player2_Score -= 1;
        var updatedGame = await gameService.UpdateGame(game);
        
        // Replace the game in the list with the updated version from the API
        var index = Games.FindIndex(g => g.ID == game.ID);
        if (index >= 0)
        {
            Games[index] = updatedGame;
        }
        
        // Notify parent component of the update
        if (OnGameUpdated.HasDelegate)
        {
            await OnGameUpdated.InvokeAsync(updatedGame);
        }
        
        RefreshResources();
        Update();
    }

    private async Task AdvancePlayer2(Game game)
    {
        game.Player2_Score += 1;
        game.Player1_Score -= 1;
        var updatedGame = await gameService.UpdateGame(game);
        
        // Replace the game in the list with the updated version from the API
        var index = Games.FindIndex(g => g.ID == game.ID);
        if (index >= 0)
        {
            Games[index] = updatedGame;
        }
        
        // Notify parent component of the update
        if (OnGameUpdated.HasDelegate)
        {
            await OnGameUpdated.InvokeAsync(updatedGame);
        }
        
        RefreshResources();
        Update();
    }

    private readonly IDictionary<string, Resource[]> _resourcesByCategory = new Dictionary<string, Resource[]>();
    private class Resource
    {
        public int Score { get; set; }
        public string Advantage { get; set; } = null!;
        public string LastJinx { get; set; } = null!;
        public Game Game { get; set; } = null!;
    }
}